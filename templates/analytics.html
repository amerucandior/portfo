<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Website Analytics Dashboard</title>

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --bg: #f4f6fb;
        --surface: #ffffff;
        --surface-muted: #eef2f7;
        --border: #e2e8f0;
        --text-1: #0f172a;
        --text-2: #475569;
        --accent-1: #5c7cff;
        --accent-2: #6f5df6;
        --accent-3: #22c55e;
        --radius-lg: 20px;
        --radius-md: 14px;
        --shadow-lg: 0 18px 44px rgba(15, 23, 42, 0.12);
        --shadow-md: 0 10px 28px rgba(15, 23, 42, 0.08);
      }

      html,
      body {
        height: 100%;
      }

      body {
        background: radial-gradient(circle at 20% 20%, #f2f5ff 0%, transparent 35%),
          radial-gradient(circle at 80% 10%, #eef2ff 0%, transparent 32%),
          linear-gradient(120deg, #f7f9fd 0%, #eaeef8 100%);
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        color: var(--text-1);
        line-height: 1.6;
        letter-spacing: 0.01em;
      }

      h1,
      h2,
      h3,
      h4 {
        font-family: "Space Grotesk", "Inter", "Segoe UI", system-ui, sans-serif;
        letter-spacing: -0.02em;
      }

      .container-fluid {
        max-width: 1240px;
        padding: 0 1.25rem;
      }

      .page-shell {
        position: relative;
        z-index: 1;
      }

      a {
        text-decoration: none;
      }

      /* Header */
      .hero {
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        position: relative;
        color: #fff;
        margin-bottom: 2rem;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 80% 10%, rgba(255, 255, 255, 0.24), transparent 35%),
          radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.14), transparent 40%);
        pointer-events: none;
      }
      .hero .overlay {
        padding: 36px 32px 30px 32px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
        display: flex;
        flex-direction: column;
        gap: 18px;
        position: relative;
        z-index: 1;
        backdrop-filter: blur(6px);
      }
      .hero h1 {
        font-weight: 700;
        letter-spacing: -0.02em;
        margin-bottom: 6px;
        font-size: 2.5rem;
        text-shadow: 0 2px 18px rgba(18, 38, 92, 0.24);
      }
      .hero p {
        opacity: 0.97;
        margin-bottom: 6px;
        font-size: 1.1rem;
      }
      .hero-meta {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .last-updated {
        font-size: 0.95rem;
        opacity: 0.92;
      }
      .eyebrow {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.82rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.78);
      }
      .eyebrow::before {
        content: "";
        width: 34px;
        height: 2px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 999px;
        display: inline-block;
      }
      .hero-actions .btn {
        font-weight: 600;
        border-radius: 10px;
        padding-inline: 14px;
        border: 1px solid rgba(255, 255, 255, 0.32);
        color: #0f172a;
      }
      .btn-ghost {
        background: rgba(255, 255, 255, 0.16);
        color: #fff;
      }
      .btn-ghost:hover {
        background: rgba(255, 255, 255, 0.24);
      }
      .btn-soft {
        background: #fff;
        color: var(--text-1);
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
      }

      /* Section headings */
      .section-heading {
        margin-bottom: 0.5rem;
      }
      .section-heading h2 {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-1);
      }
      .section-heading .lede {
        color: var(--text-2);
        margin: 0;
        font-size: 0.98rem;
      }

      /* Stat cards */
      .stat-card {
        border: 1px solid var(--border);
        border-radius: 18px;
        transition: transform 180ms ease, box-shadow 180ms ease;
        box-shadow: var(--shadow-md);
        background: linear-gradient(140deg, #f8fbff 60%, #eef2ff 100%);
        padding: 1.7rem 1.5rem;
        min-height: 160px;
        display: flex;
        align-items: center;
      }
      .stat-card:hover {
        transform: translateY(-6px);
        box-shadow: var(--shadow-lg);
      }
      .stat-title {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.8rem;
        color: var(--text-2);
        margin-bottom: 8px;
      }
      .stat-value {
        font-family: "Space Grotesk", "Inter", system-ui, sans-serif;
        font-weight: 700;
        font-size: 2.4rem;
        letter-spacing: -0.02em;
        margin-bottom: 2px;
      }
      .stat-desc {
        color: var(--text-2);
        font-size: 0.98rem;
      }
      .stat-icon {
        background: linear-gradient(135deg, #fff 60%, #e9eaf3 100%);
        border-radius: 14px;
        padding: 0.65em;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.8);
      }

      /* Cards & tables */
      .card {
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 10px 24px rgba(20, 24, 42, 0.04);
        background: #fff;
      }
      .card .card-header {
        background: linear-gradient(90deg, rgba(92, 124, 255, 0.06), transparent);
        border-bottom: 1px solid var(--border);
        font-weight: 700;
        font-size: 1.05rem;
        padding: 0.9rem 1.2rem;
      }
      .card .card-header h5 {
        margin: 0;
      }
      .table thead th {
        border-bottom: 1px solid var(--border);
        background: transparent;
        color: var(--text-2);
        font-weight: 700;
        font-size: 0.9rem;
        letter-spacing: 0.02em;
      }
      .table tbody tr:hover {
        background: rgba(92, 124, 255, 0.06);
      }
      .table tbody td {
        color: var(--text-1);
      }
      .badge-pill {
        border-radius: 999px;
        padding: 0.45em 0.7em;
        font-weight: 700;
        font-size: 1rem;
      }
      .pill-soft {
        background: rgba(92, 124, 255, 0.12);
        color: var(--accent-1);
        border-radius: 999px;
        padding: 0.2rem 0.75rem;
        font-weight: 700;
        font-size: 0.84rem;
        letter-spacing: 0.02em;
      }

      /* Browser tiles */
      .browser-tile {
        background: linear-gradient(180deg, #ffffff 0%, #f5f6fb 100%);
        border-radius: 14px;
        box-shadow: 0 10px 20px rgba(30, 34, 60, 0.06);
        padding: 1rem;
        min-width: 140px;
        border: 1px solid var(--border);
      }

      /* Charts */
      canvas {
        max-height: 320px;
      }
      .chart-card {
        padding: 1.5rem 1rem 1rem 1rem;
        background: linear-gradient(120deg, #f8fafc 80%, #e9eaf3 100%);
        border-radius: 12px;
      }

      /* Responsive tweaks */
      @media (max-width: 991px) {
        .stat-value {
          font-size: 2rem;
        }
        .hero h1 {
          font-size: 2rem;
        }
        .stat-card {
          min-height: 120px;
          padding: 1.4rem 1rem;
        }
      }
      @media (max-width: 767px) {
        .stat-value {
          font-size: 1.5rem;
        }
        .hero h1 {
          font-size: 1.4rem;
        }
        .hero .overlay {
          padding: 20px 14px 18px 14px;
        }
      }

      /* subtle icon helper */
      .muted-icon {
        color: rgba(0, 0, 0, 0.45);
      }

      /* tiny helper for code blocks in tables */
      code {
        font-size: 0.92rem;
        background: rgba(18, 20, 24, 0.04);
        padding: 0.18rem 0.45rem;
        border-radius: 6px;
      }
    </style>

  </head>

  <body>
    <main class="page-shell">
      <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
          <div class="col">
            <div class="hero">
              <div
                class="overlay d-flex justify-content-between align-items-start align-items-md-center flex-column flex-md-row"
              >
                <div class="d-flex flex-column gap-2">
                  <span class="eyebrow">Live overview</span>
                  <h1 class="mb-0">üìä Website Analytics</h1>
                  <p class="mb-1">
                    Real-time tracking and clean insights for your portfolio
                  </p>
                  <div class="hero-meta">
                    <small class="last-updated"
                      ><i class="bi bi-clock-history muted-icon"></i> Last
                      updated: {{ today.strftime('%Y-%m-%d %H:%M') }}</small
                    >
                    <span class="pill-soft">Healthy traffic</span>
                  </div>
                </div>
                <div class="hero-actions mt-3 mt-md-0 d-flex gap-2">
                  <button class="btn btn-ghost btn-sm" type="button">
                    <i class="bi bi-share-fill"></i> Share
                  </button>
                  <a href="/admin/analytics/export" class="btn btn-soft btn-sm">
                    <i class="bi bi-download"></i> Export CSV
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="section-heading">
            <h2 class="mb-1">Key Metrics</h2>
            <p class="lede">Snapshot of engagement and reach.</p>
          </div>
          <span class="pill-soft d-none d-md-inline-flex">Live data</span>
        </div>

        <!-- Key Metrics -->
        <div class="row g-4 mb-4">
          <div class="col-md-4">
            <div class="card stat-card">
              <div
                class="d-flex justify-content-between align-items-center w-100"
              >
                <div>
                  <div class="stat-title text-primary">Total Page Views</div>
                  <div class="stat-value text-primary">{{ total_views }}</div>
                  <div class="stat-desc">All-time total visits</div>
                </div>
                <div class="stat-icon ms-3 text-end">
                  <i class="bi bi-eye text-primary fs-3"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card stat-card">
              <div
                class="d-flex justify-content-between align-items-center w-100"
              >
                <div>
                  <div class="stat-title text-success">Unique Visitors</div>
                  <div class="stat-value text-success">
                    {{ total_unique_visitors }}
                  </div>
                  <div class="stat-desc">Individual visitors</div>
                </div>
                <div class="stat-icon ms-3 text-end">
                  <i class="bi bi-people-fill text-success fs-3"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card stat-card">
              <div
                class="d-flex justify-content-between align-items-center w-100"
              >
                <div>
                  <div class="stat-title text-warning">Views Today</div>
                  <div class="stat-value text-warning">{{ views_today }}</div>
                  <div class="stat-desc">Page views in the last 24 hours</div>
                </div>
                <div class="stat-icon ms-3 text-end">
                  <i class="bi bi-sun-fill text-warning fs-3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="section-heading">
            <h2 class="mb-1">Traffic Quality</h2>
            <p class="lede">Behavior trends and browser mix.</p>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-4">
          <div class="col-lg-8">
            <div class="card h-100">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">
                  üìà Visits Over Time
                  <span class="text-muted fs-6">(Last 7 Days)</span>
                </h5>
              </div>
              <div class="card-body chart-card">
                <canvas id="visitsChart"></canvas>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card h-100">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">üåê Browser Usage</h5>
                <small class="text-muted">Top browsers</small>
              </div>
              <div class="card-body chart-card">
                <canvas id="browserChart"></canvas>
                <div class="mt-3">
                  <div class="d-flex flex-wrap gap-2">
                    {% for browser in browser_stats %}
                    <div class="browser-tile p-2 d-flex align-items-center gap-2">
                      <div class="flex-grow-1">
                        <div class="fw-semibold">{{ browser.browser }}</div>
                        <div class="text-muted small">
                          {{ ((browser.count /
                          (browser_stats|map(attribute='count')|sum) * 100) |
                          round(1)) }}%
                        </div>
                      </div>
                      <div class="text-end">
                        <div class="badge badge-pill bg-light text-dark">
                          {{ browser.count }}
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2 mt-2">
          <div class="section-heading">
            <h2 class="mb-1">Engagement Trails</h2>
            <p class="lede">Content your audience returns to.</p>
          </div>
        </div>

        <!-- Popular Pages & Recent Activity -->
        <div class="row g-4 mb-4">
          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-header">
                <h5 class="mb-0">üî• Most Popular Pages</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th>Page URL</th>
                        <th class="text-end">Views</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for page in popular_pages %}
                      <tr>
                        <td>
                          <div class="d-flex align-items-center gap-3">
                            <div class="flex-grow-1">
                              <div class="fw-medium">
                                <code>{{ page.page_url }}</code>
                              </div>
                              <div class="text-muted small">
                                Last viewed: {{ page.last_viewed if
                                page.last_viewed else "‚Äî" }}
                              </div>
                            </div>
                          </div>
                        </td>
                        <td class="text-end">
                          <span class="badge bg-primary rounded-pill badge-pill"
                            >{{ page.views }}</span
                          >
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-header">
                <h5 class="mb-0">üïí Recent Activity</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead>
                      <tr>
                        <th>Page</th>
                        <th>IP</th>
                        <th>Time</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for view in recent_views %}
                      <tr>
                        <td>
                          <small><code>{{ view.page_url }}</code></small>
                        </td>
                        <td>
                          <small class="text-muted">{{ view.ip_address }}</small>
                        </td>
                        <td>
                          <small class="text-muted">{{ view.timestamp }}</small>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2 mt-2">
          <div class="section-heading">
            <h2 class="mb-1">Browser & Device</h2>
            <p class="lede">Distribution by client and platform.</p>
          </div>
        </div>

        <!-- Browser & Device Breakdown -->
        <div class="row g-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">üîç Browser & Device Breakdown</h5>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  {% for browser in browser_stats %}
                  <div class="col-sm-6 col-md-3">
                    <div
                      class="p-3 browser-tile h-100 d-flex justify-content-between align-items-center"
                    >
                      <div>
                        <div class="fw-bold">{{ browser.browser }}</div>
                        <div class="text-muted small">
                          {{ browser.device or 'Desktop / Mobile' }}
                        </div>
                      </div>
                      <div class="text-end">
                        <div class="badge bg-secondary rounded-pill">
                          {{ browser.count }} views
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Optional: Bootstrap bundle (includes Popper) if you want tooltips or dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript for Charts -->
    <script>
      // Helper formatter
      const numberFmt = new Intl.NumberFormat(undefined);

      // Visits over time: fetch data and draw with gradient fill
      fetch("/admin/analytics/api/visits-over-time")
        .then((response) => response.json())
        .then((data) => {
          const canvas = document.getElementById("visitsChart");
          const ctx = canvas.getContext("2d");

          // create gradient using canvas height
          const gradient = ctx.createLinearGradient(0, 0, 0, 300);
          gradient.addColorStop(0, "rgba(102,126,234,0.18)");
          gradient.addColorStop(1, "rgba(118,75,162,0.02)");

          new Chart(ctx, {
            type: "line",
            data: {
              labels: data.dates,
              datasets: [
                {
                  label: "Daily Visits",
                  data: data.visits,
                  borderColor: "#4f46e5",
                  backgroundColor: gradient,
                  pointBackgroundColor: "#fff",
                  pointBorderColor: "#4f46e5",
                  tension: 0.35,
                  fill: true,
                  pointRadius: 3,
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return numberFmt.format(context.parsed.y) + " visits";
                    },
                  },
                },
              },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: { color: "#475569" },
                },
                y: {
                  ticks: {
                    callback: function (value) {
                      return numberFmt.format(value);
                    },
                    color: "#475569",
                  },
                  grid: { color: "rgba(15,23,42,0.04)" },
                },
              },
            },
          });
        })
        .catch((err) => {
          console.error("Failed to load visits-over-time:", err);
        });

      // Browser usage chart
      const browserCtx = document
        .getElementById("browserChart")
        .getContext("2d");
      // Wrap server-rendered JSON in string literals and parse so the JS parser sees valid strings
      const browserLabels = JSON.parse(
        '{{ browser_stats|map(attribute="browser")|list|tojson }}'
      );
      const browserCounts = JSON.parse(
        '{{ browser_stats|map(attribute="count")|list|tojson }}'
      );

      const browserData = {
        labels: browserLabels,
        datasets: [
          {
            data: browserCounts,
            backgroundColor: [
              "#FF6384",
              "#36A2EB",
              "#FFCE56",
              "#4BC0C0",
              "#9966FF",
              "#FF9F40",
            ],
            hoverOffset: 6,
            borderWidth: 0,
          },
        ],
      };

      new Chart(browserCtx, {
        type: "doughnut",
        data: browserData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "62%",
          plugins: {
            legend: {
              position: "bottom",
              labels: { boxWidth: 10, padding: 12 },
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || "";
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const pct = total
                    ? ((value / total) * 100).toFixed(1)
                    : "0.0";
                  return (
                    label + ": " + numberFmt.format(value) + " (" + pct + "%)"
                  );
                },
              },
            },
          },
        },
      });
    </script>
  </body>
</html>
